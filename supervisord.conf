[supervisord]
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor
nodaemon=true

[program:vllm]
command=/opt/venv/bin/python -m vllm.entrypoints.openai.api_server \
    --host 0.0.0.0 \
    --port %(ENV_VLLM_PORT)s \
    --model %(ENV_VLLM_MODEL)s \
    --download-dir /workspace/models \
    --max-model-len 131072 \
    --gpu-memory-utilization 0.95 \
    --dtype auto \
    --kv-cache-dtype fp8 \
    --enforce-eager
stdout_logfile=/var/log/supervisor/vllm.out.log
stderr_logfile=/var/log/supervisor/vllm.err.log
autorestart=true
startretries=999
priority=10

[program:openwebui]
environment=OPENAI_API_BASE_URL=http://127.0.0.1:%(ENV_VLLM_PORT)s/v1,OPENAI_API_KEY=dummy,ENABLE_OPENAI_API=true,DATA_DIR=%(ENV_OWUI_DATA_DIR)s
command=/opt/venv/bin/open-webui serve --host 0.0.0.0 --port %(ENV_OWUI_PORT)s --data-dir %(ENV_OWUI_DATA_DIR)s
stdout_logfile=/var/log/supervisor/openwebui.out.log
stderr_logfile=/var/log/supervisor/openwebui.err.log
autorestart=true
startretries=999
priority=20

[program:jupyter]
command=/opt/venv/bin/jupyter lab --NotebookApp.token='' --NotebookApp.password='' --ip=0.0.0.0 --port %(ENV_JUPYTER_PORT)s --no-browser --NotebookApp.allow_origin='*' --ServerApp.allow_remote_access=True
stdout_logfile=/var/log/supervisor/jupyter.out.log
stderr_logfile=/var/log/supervisor/jupyter.err.log
autorestart=true
priority=30

[program:syncthing]
command=/usr/bin/syncthing -no-browser -gui-address=0.0.0.0:%(ENV_SYNCTHING_PORT)s -home=/workspace/.syncthing
stdout_logfile=/var/log/supervisor/syncthing.out.log
stderr_logfile=/var/log/supervisor/syncthing.err.log
autorestart=true
priority=30

[program:node_exporter]
command=/usr/bin/prometheus-node-exporter --web.listen-address=0.0.0.0:%(ENV_NODE_EXPORTER_PORT)s
stdout_logfile=/var/log/supervisor/nodeexporter.out.log
stderr_logfile=/var/log/supervisor/nodeexporter.err.log
autorestart=true
priority=40

[program:otelcol]
command=/usr/bin/otelcol --config=/etc/otelcol/config.yaml
stdout_logfile=/var/log/supervisor/otel.out.log
stderr_logfile=/var/log/supervisor/otel.err.log
autorestart=true
priority=40

# Caddy front door reverse proxy (serves local + used by cloudflared)
[program:caddy]
command=/usr/local/bin/caddy run --config /etc/caddy/Caddyfile --adapter caddyfile
stdout_logfile=/var/log/supervisor/caddy.out.log
stderr_logfile=/var/log/supervisor/caddy.err.log
autorestart=true
priority=50

# Cloudflared quick tunnel exposing the Caddy front door (public URL)
[program:cloudflared]
command=/usr/local/bin/cloudflared tunnel --no-autoupdate --url http://127.0.0.1:%(ENV_CADDY_PORT)s
stdout_logfile=/var/log/supervisor/cloudflared.out.log
stderr_logfile=/var/log/supervisor/cloudflared.err.log
autorestart=true
startretries=999
priority=60
